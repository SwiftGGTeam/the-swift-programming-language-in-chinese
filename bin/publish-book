#! /bin/bash

# This source file is part of the Swift.org open source project
#
# Copyright (c) 2023 Apple Inc. and the Swift project authors
# Licensed under Apache License v2.0 with Runtime Library Exception
#
# See https://swift.org/LICENSE.txt for license information
# See https://swift.org/CONTRIBUTORS.txt for Swift project authors

# Prepares a version of the book suitable for publication on swift.org.

set -eux

# Pretty print DocC JSON output, so that it has a stable ordering and
# can be diffed.  This lets us determine whether rebuilding resulted in
# any changes to the content.
export DOCC_JSON_PRETTYPRINT="YES"

output="./swift-book"

# Start at the top level directory of the repository.
cd "$(git rev-parse --show-toplevel)"

# Summarize the formal grammar at the end of the reference.
summary_chapter="TSPL.docc/ReferenceManual/SummaryOfTheGrammar.md"
if [[ -f $summary_chapter ]]
then
       echo "Summary of the grammar already exists"
       exit 1
fi
{
	echo "# Summary of the Grammar"
	echo
	echo "Read the whole formal grammar."
	echo
	awk -f bin/extract_grammar.awk TSPL.docc/ReferenceManual/LexicalStructure.md
	awk -f bin/extract_grammar.awk TSPL.docc/ReferenceManual/Types.md
	awk -f bin/extract_grammar.awk TSPL.docc/ReferenceManual/Expressions.md
	awk -f bin/extract_grammar.awk TSPL.docc/ReferenceManual/Statements.md
	awk -f bin/extract_grammar.awk TSPL.docc/ReferenceManual/Declarations.md
	awk -f bin/extract_grammar.awk TSPL.docc/ReferenceManual/Attributes.md
	awk -f bin/extract_grammar.awk TSPL.docc/ReferenceManual/Patterns.md
	awk -f bin/extract_grammar.awk TSPL.docc/ReferenceManual/GenericParametersAndArguments.md
} > $summary_chapter

# The published version of the book gets the swift.org header.
cp -n TSPL.docc/header-publish.html TSPL.docc/header.html

xcrun docc convert \
    --experimental-enable-custom-templates \
    --hosting-base-path swift-book \
    --output-path "$output" \
    TSPL.docc

rm TSPL.docc/header.html
rm $summary_chapter

# Copy the redirect pages into every location where the legacy RST-based
# pipeline created an HTML page, to keep links to those chapters and
# sections working.
cp -r bin/redirects/GuidedTour "$output"
cp -r bin/redirects/LanguageGuide "$output"
cp -r bin/redirects/ReferenceManual "$output"
cp -r bin/redirects/RevisionHistory "$output"
cp -r bin/redirects/index.html "$output"

# Add a redirect page from swift.org/swift-book/documentation/.
cp -r bin/redirects/documentation/index.html "$output/documentation/"
